# Story 1.1: Passenger Registration

## Status
Draft

## Story
**As a** passenger,
**I want** to sign up using my phone number,
**so that** I can access the booking system and create my account securely.

## Acceptance Criteria

1. User can enter phone number in international format (+254XXXXXXXXX)
2. System validates phone number format and checks for duplicates
3. System sends OTP via SMS for verification using Africa's Talking API
4. User can enter the received OTP within 5 minutes
5. System verifies OTP and creates passenger profile in database
6. User receives welcome message upon successful registration
7. System handles duplicate phone number scenarios with appropriate error messages
8. Registration process includes basic error handling for network failures

## Technical Context

### Architecture Components Involved
- **Auth Service**: Primary service for handling registration
- **Database**: user_profiles table for storing user data
- **External APIs**: Africa's Talking SMS API for OTP delivery
- **Supabase Auth**: Integration for authentication management

### Database Schema Reference
```sql
-- From backend/shared/database/init.sql
CREATE TABLE user_profiles (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID UNIQUE NOT NULL, -- References auth.users(id)
    phone VARCHAR(15) UNIQUE NOT NULL,
    first_name VARCHAR(100),
    last_name VARCHAR(100),
    email VARCHAR(255),
    role user_role NOT NULL DEFAULT 'passenger',
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

### API Endpoints to Implement
- `POST /api/auth/register/initiate` - Start registration with phone number
- `POST /api/auth/register/verify` - Verify OTP and complete registration
- `GET /api/auth/register/resend` - Resend OTP if needed

## Tasks / Subtasks

### Backend Implementation (Auth Service)
1. **Setup Auth Service Structure**
   - Create FastAPI application structure in `backend/services/auth/`
   - Set up database connection and models
   - Configure environment variables and dependencies

2. **Implement Phone Number Validation**
   - Create phone number validation utility
   - Support international format validation
   - Handle Kenyan phone number formats specifically

3. **Integrate SMS Provider (Africa's Talking)**
   - Set up Africa's Talking SDK
   - Create OTP generation and sending functionality
   - Implement retry logic for SMS failures

4. **Create Registration Endpoints**
   - `POST /api/auth/register/initiate`: Validate phone, generate OTP, send SMS
   - `POST /api/auth/register/verify`: Verify OTP, create user profile
   - `GET /api/auth/register/resend`: Resend OTP with rate limiting

5. **Database Integration**
   - Create user profile model using SQLAlchemy
   - Implement database operations for user creation
   - Add proper error handling for duplicate entries

6. **Supabase Auth Integration**
   - Configure Supabase client in auth service
   - Implement user creation in Supabase auth
   - Link Supabase user ID with local user profile

### Frontend Implementation (React PWA)
7. **Create Registration UI Components**
   - Phone number input component with validation
   - OTP input component with timer
   - Success/error message components
   - Loading states and progress indicators

8. **Implement Registration Flow**
   - Phone number entry screen
   - OTP verification screen
   - Success confirmation screen
   - Error handling and retry mechanisms

### Testing
9. **Unit Tests**
   - Phone number validation tests
   - OTP generation and verification tests
   - Database operation tests
   - API endpoint tests

10. **Integration Tests**
    - End-to-end registration flow testing
    - SMS provider integration testing
    - Database integration testing

## Dev Notes

### Implementation Completed ✅
**Date**: 2025-01-18
**Developer**: Alex (Dev Agent)

#### Backend Implementation Status
- ✅ **Auth Service Structure**: Complete FastAPI application with proper project structure
- ✅ **Phone Number Validation**: Comprehensive validation for Kenyan phone numbers with multiple format support
- ✅ **SMS Integration**: Africa's Talking integration with development mocking capability
- ✅ **OTP System**: Secure OTP generation, hashing, and verification with Redis storage
- ✅ **Registration Endpoints**: All three endpoints implemented with proper error handling
- ✅ **Database Integration**: SQLAlchemy models with async support and Supabase integration
- ✅ **Rate Limiting**: Redis-based rate limiting for registration attempts and OTP resends

#### Key Technical Decisions
1. **Phone Validation**: Supports multiple Kenyan formats (+254, 254, 0 prefix) with normalization
2. **OTP Security**: Uses HMAC-based hashing with phone+OTP+secret for secure verification
3. **SMS Mocking**: Development environment mocks SMS sending for testing without API costs
4. **Error Handling**: Comprehensive error responses with specific error codes for client handling
5. **Rate Limiting**: Multiple rate limits - registration attempts, OTP resends, and verification attempts
6. **Database Design**: Async SQLAlchemy with proper UUID handling and Supabase auth integration

#### Files Created
- `backend/services/auth/main.py` - FastAPI application entry point
- `backend/services/auth/app/core/` - Configuration, database, Redis setup
- `backend/services/auth/app/models/user_profile.py` - User profile model
- `backend/services/auth/app/utils/` - Phone validation and OTP utilities
- `backend/services/auth/app/services/` - SMS and registration services
- `backend/services/auth/app/schemas/auth.py` - Pydantic request/response schemas
- `backend/services/auth/app/api/v1/endpoints/auth.py` - Registration API endpoints
- `backend/services/auth/tests/` - Unit tests for utilities
- `backend/services/auth/requirements.txt` - Python dependencies
- `backend/services/auth/Dockerfile` - Container configuration

#### Testing Status
- ✅ **Unit Tests**: Phone validator and OTP generator tests implemented
- ⏳ **Integration Tests**: Pending - need database and Redis setup
- ⏳ **API Tests**: Pending - need test client setup
- ⏳ **Manual Testing**: Pending - need Docker environment running

#### Next Steps for Testing
1. Set up test database and Redis instances
2. Create API integration tests
3. Test complete registration flow end-to-end
4. Verify SMS integration in staging environment

## Testing Strategy

### Unit Testing
- Test phone number validation with various formats
- Test OTP generation and expiry logic
- Test database operations and error scenarios
- Mock external SMS API for consistent testing

### Integration Testing
- Test complete registration flow from phone input to user creation
- Test SMS delivery integration (use test numbers in development)
- Test database constraints and duplicate handling

### Manual Testing Checklist
- [ ] Valid Kenyan phone numbers accepted
- [ ] Invalid phone numbers rejected with clear messages
- [ ] OTP received within reasonable time
- [ ] OTP verification works correctly
- [ ] Duplicate registration handled properly
- [ ] Network failure scenarios handled gracefully

## Dependencies
- Africa's Talking SMS API credentials
- Supabase project configuration
- PostgreSQL database setup
- Redis for OTP storage and rate limiting

## Definition of Done
- [ ] All acceptance criteria implemented and tested
- [ ] Unit tests written and passing (>90% coverage)
- [ ] Integration tests written and passing
- [ ] API endpoints documented in OpenAPI/Swagger
- [ ] Frontend components responsive and accessible
- [ ] Error handling comprehensive and user-friendly
- [ ] Code reviewed and approved
- [ ] Manual testing completed successfully

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-18 | 1.0 | Initial story creation | SM Agent |

---

**Epic**: 1 - User Authentication & Account Management  
**Priority**: P0 (Critical)  
**Estimated Effort**: 8 Story Points  
**Sprint**: 1
